(()=>{"use strict";const e=window.wp.htmlEntities,t=window.React,s=window.wp.i18n,n=window.ReactJSXRuntime,{CheckboxControl:a}=window.wc.blocksCheckout,r=t=>{const{description:s}=t;return(0,e.decodeEntities)(s||"")},o=e=>{let{src:t,name:s=""}=e.icon;return"string"==typeof e.icon&&(t=e.icon),(0,n.jsx)("img",{style:{maxHeight:"20px"},src:t,title:s,alt:s,loading:"lazy"})},i=e=>{const{icons:t,additional:a}=e;return t.length?(0,n.jsxs)("span",{style:{display:"flex",flexWrap:"wrap",gap:"6px",fontSize:"65%",alignItems:"center",justifyContent:"flex-end"},children:[t.map((({src:e,name:t},s)=>(0,n.jsx)(o,{icon:{src:e,name:t}},s))),a?(0,n.jsx)("span",{style:{lineHeight:"1.2"},children:(0,s.sprintf)((0,s.__)("+%d other methods","woocommerce-p24"),a)}):""]}):""},c=({required:e=!1,label:t,checked:s,onChange:r,...o})=>(0,n.jsx)(a,{required:e,label:(0,n.jsx)("span",{dangerouslySetInnerHTML:{__html:t}}),checked:s,onChange:r,...o,__nextHasNoMarginBottom:!0}),l=e=>{const{PaymentMethodLabel:t}=e.components,{label:s,icon:a,icons:r,additional:c}=e;return(0,n.jsxs)("span",{style:{width:"100%",display:"flex",gap:"12px",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsx)(t,{text:s}),r?(0,n.jsx)(i,{icons:r,additional:c}):"",a?(0,n.jsx)(o,{icon:a}):""]})};class d{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}class h extends d{constructor(){super(),this.paymentDetails={total:"0.00",currency:""},this.token=null,this.cancel=!1,this.paymentClient=null,this.paymentCanBeUsed=!1}reset(){super.reset(),this.cancel=!1,this.token=null}isCanceled(){return this.cancel}setCancel(e){this.cancel=e}setPaymentDetails(e,t){this.paymentDetails={total:parseFloat(e).toFixed(2).toString(),currency:t}}getPaymentData(){const{regulation:e}=this;return{payload:!!this.token&&btoa(this.token),regulation:e}}}const u=async(e,t,s=()=>{},n=!1)=>{let a=document.getElementById(e);if(a&&n&&(a.remove(),a=!1),!a){const n=document.createElement("script");return n.src=t,n.id=e,document.head.appendChild(n),await new Promise((e=>{n.addEventListener("load",(()=>e(s())))}))}return s(),!0},m=class{constructor(e){const{mode:t="sandbox",debug:s=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=s,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}getLoader(){return document.getElementById("p24-3ds-loader")}openModal(){const e=this.getModal(),t=this.getLoader();e&&(e.classList.remove("hidden"),e.classList.add("active")),t&&t.classList.remove("hidden")}closeModal(){const e=this.getModal(),t=this.getLoader();e&&(e.classList.add("hidden"),e.classList.remove("active")),t&&t.classList.add("hidden")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();e&&new MutationObserver((t=>{t.forEach((()=>{const t=e.querySelector("iframe");t&&t.addEventListener("load",(()=>{const e=this.getLoader();e&&e.classList.add("hidden")}),{once:!0})}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await u("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0);const t=this.getLoader(),s=this.getModal();if(t&&s){const e=setTimeout((()=>{t&&t.classList.add("hidden")}),12e3),s=this.getIframeWrapper(),n=s?s.querySelector("iframe"):null;n&&n.addEventListener("load",(()=>clearTimeout(e)),{once:!0})}}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,s)=>{const{error:n,token:a,redirect:r}=e;this.promise.resolve=t,this.promise.reject=s,this.promise.redirect=r,n?t({error:n}):a&&(this.debug&&console.log("[P24] Transaction token:",a),this.load(a),r&&console.log("[P24] Redirect fallback:",r))}))}},{registerPaymentMethod:g}=window.wc.wcBlocksRegistry,{getSetting:p}=window.wc.wcSettings,{ValidationInputError:y}=window.wc.blocksCheckout,w=p("p24-google-pay_data",{}),b=(0,e.decodeEntities)(w.title),C=w?.i18n||{},f=new class extends h{constructor(e){super();const{config:t,mode:s="sandbox",debug:n=!1}=e,{merchantId:a,googleMerchantId:r,merchantName:o}=t;this.debug=n,this.env="sandbox"===s?"TEST":"PRODUCTION",this.mode=s,this.whiteLabel=new m(e),this.merchantId=a,this.tokenizationParams={gateway:"przelewy24",gatewayMerchantId:"exampleGatewayMerchantId"},this.merchantInfo={merchantId:r,merchantName:o},"PRODUCTION"===this.env&&(this.tokenizationParams.gatewayMerchantId=this.merchantId)}async init(){await u("google-pay","https://pay.google.com/gp/p/js/pay.js",(()=>this.getClient()))}async canPayment(){if(this.paymentCanBeUsed)return!0;const e=this.getClient();if(!e)return!1;try{const{result:t=!1}=await e.isReadyToPay(this.getBasePaymentRequest());return this.paymentCanBeUsed=t,t}catch(e){return!1}}getClient(){return null===this.paymentClient&&window.google?.payments&&(this.paymentClient=new google.payments.api.PaymentsClient(this.getClientData())),this.paymentClient}getClientData(){const{merchantInfo:e,regulation:t}=this,s={environment:this.env,merchantInfo:e};return this.debug&&console.log("Client data:",s),s}getBasePaymentRequest(){const{tokenizationParams:e}=this,t={apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:[{type:"CARD",tokenizationSpecification:{type:"PAYMENT_GATEWAY",parameters:e},parameters:{allowedAuthMethods:["PAN_ONLY","CRYPTOGRAM_3DS"],allowedCardNetworks:["AMEX","DISCOVER","JCB","MASTERCARD","VISA"]}}]};return this.debug&&console.log("Base payment data",t),t}getPaymentRequest(){const{merchantInfo:e,paymentDetails:t}=this,{total:s,currency:n}=t,a={...this.getBasePaymentRequest(),merchantInfo:e,transactionInfo:{currencyCode:n,totalPriceStatus:"FINAL",totalPrice:s}};return this.debug&&console.log("Payment data",a),a}async processPayment(){this.reset();let e=this.getClient();try{const t=await e.loadPaymentData(this.getPaymentRequest());this.token=t.paymentMethodData.tokenizationData.token,this.debug&&console.log("Result",this.token,t)}catch(e){"CANCELED"===e?.statusCode?this.setCancel(!0):this.setError(e?.statusMessage||e?.message||null)}}}(w),P=({eventRegistration:e,emitResponse:s})=>{const{responseTypes:a,noticeContexts:o}=s,{onPaymentSetup:i,onCheckoutSuccess:l,onCheckoutFail:d}=e,[h,u,m,g]=function(e,s){const[n,a]=(0,t.useState)(""),[r,o]=(0,t.useState)(!1),[i,c]=(0,t.useState)(!1),[l,d]=(0,t.useState)(!0);return(0,t.useEffect)((()=>{i&&a(l&&!r?s:"")}),[r,l,i]),[r,n,t=>{i||c(!0),e&&e.setRegulation(t),o(t)},(e=!0)=>{let t=!1;return e&&!r?(a(s),t=!1):(e&&r||!e)&&(a(""),t=!0),t},e=>{e||a(""),d(e)}]}(f,C.error.rules);return(0,t.useEffect)((()=>{f.whiteLabel.init(),f.whiteLabel.runObserver()}),[]),(0,t.useEffect)((()=>{const e=i((async()=>{const e={type:a.ERROR};if(!g())return e;const t=(()=>{const{data:e}=window.wp,{CART_STORE_KEY:t}=window.wc.wcBlocksData,s=e.select(t).getCartTotals(),n=e.select(t).getCartData();return{total:Number(s.total_price)/100,currency:s.currency_code,country:n.billingAddress?.country||"PL"}})();return f.setPaymentDetails(t.total,t.currency),await f.processPayment(),f.hasError()||f.isCanceled()?e.message=f.getError():(e.type=a.SUCCESS,e.meta={paymentMethodData:f.getPaymentData()}),e}));return()=>{e()}}),[a.ERROR,a.SUCCESS,i,h,u]),(0,t.useEffect)((()=>{const e=l((async({processingResponse:e})=>{const t={type:a.ERROR},{success:s,error:n,redirect:r}=await f.whiteLabel.onResponse(e?.paymentDetails||{});return s&&r&&(t.type=a.SUCCESS,t.redirectUrl=r),n&&(t.message=n,t.messageContext=o.PAYMENTS),t})),t=d((({processingResponse:e})=>{const{message:t}=e?.paymentDetails||{},s={type:a.ERROR};return t&&(s.message=t,s.messageContext=o.PAYMENTS),s}));return()=>{e(),t()}}),[a.ERROR,a.SUCCESS,l,d]),(0,n.jsxs)("div",{className:"p24-payment-container",children:[w.description&&(0,n.jsx)(r,{description:w.description}),(0,n.jsx)("div",{id:"card-whitelabel"}),(0,n.jsxs)("div",{className:"p24-checkbox",children:[(0,n.jsx)(c,{required:!0,label:C.label.regulation,checked:h,onChange:m}),u?(0,n.jsx)(y,{errorMessage:u}):""]})]})};g({name:w.name,label:(0,n.jsx)(l,{label:b,icon:w.icon}),content:(0,n.jsx)(P,{}),edit:(0,n.jsx)(r,{description:w.description}),canMakePayment:async()=>(await f.init(),await f.canPayment()),ariaLabel:b,placeOrderButtonLabel:C.label.submit,supports:{features:w.supports}})})();