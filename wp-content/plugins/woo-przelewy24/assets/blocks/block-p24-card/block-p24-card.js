(()=>{"use strict";const e=window.wp.htmlEntities,t=window.React,s=window.wp.i18n,n=window.ReactJSXRuntime,{CheckboxControl:r}=window.wc.blocksCheckout,i=t=>{const{description:s}=t;return(0,e.decodeEntities)(s||"")},a=e=>{let{src:t,name:s=""}=e.icon;return"string"==typeof e.icon&&(t=e.icon),(0,n.jsx)("img",{style:{maxHeight:"20px"},src:t,title:s,alt:s,loading:"lazy"})},o=e=>{const{icons:t,additional:r}=e;return t.length?(0,n.jsxs)("span",{style:{display:"flex",flexWrap:"wrap",gap:"6px",fontSize:"65%",alignItems:"center",justifyContent:"flex-end"},children:[t.map((({src:e,name:t},s)=>(0,n.jsx)(a,{icon:{src:e,name:t}},s))),r?(0,n.jsx)("span",{style:{lineHeight:"1.2"},children:(0,s.sprintf)((0,s.__)("+%d other methods","woocommerce-p24"),r)}):""]}):""},c=({required:e=!1,label:t,checked:s,onChange:i,...a})=>(0,n.jsx)(r,{required:e,label:(0,n.jsx)("span",{dangerouslySetInnerHTML:{__html:t}}),checked:s,onChange:i,...a,__nextHasNoMarginBottom:!0}),l=e=>{const{PaymentMethodLabel:t}=e.components,{label:s,icon:r,icons:i,additional:c}=e;return(0,n.jsxs)("span",{style:{width:"100%",display:"flex",gap:"12px",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsx)(t,{text:s}),i?(0,n.jsx)(o,{icons:i,additional:c}):"",r?(0,n.jsx)(a,{icon:r}):""]})};class d{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}const u=async(e,t,s=()=>{},n=!1)=>{let r=document.getElementById(e);if(r&&n&&(r.remove(),r=!1),!r){const n=document.createElement("script");return n.src=t,n.id=e,document.head.appendChild(n),await new Promise((e=>{n.addEventListener("load",(()=>e(s())))}))}return s(),!0},h=class{constructor(e){const{mode:t="sandbox",debug:s=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=s,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}getLoader(){return document.getElementById("p24-3ds-loader")}openModal(){const e=this.getModal(),t=this.getLoader();e&&(e.classList.remove("hidden"),e.classList.add("active")),t&&t.classList.remove("hidden")}closeModal(){const e=this.getModal(),t=this.getLoader();e&&(e.classList.add("hidden"),e.classList.remove("active")),t&&t.classList.add("hidden")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();e&&new MutationObserver((t=>{t.forEach((()=>{const t=e.querySelector("iframe");t&&t.addEventListener("load",(()=>{const e=this.getLoader();e&&e.classList.add("hidden")}),{once:!0})}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await u("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0);const t=this.getLoader(),s=this.getModal();if(t&&s){const e=setTimeout((()=>{t&&t.classList.add("hidden")}),12e3),s=this.getIframeWrapper(),n=s?s.querySelector("iframe"):null;n&&n.addEventListener("load",(()=>clearTimeout(e)),{once:!0})}}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,s)=>{const{error:n,token:r,redirect:i}=e;this.promise.resolve=t,this.promise.reject=s,this.promise.redirect=i,n?t({error:n}):r&&(this.debug&&console.log("[P24] Transaction token:",r),this.load(r),i&&console.log("[P24] Redirect fallback:",i))}))}},{registerPaymentMethod:m}=window.wc.wcBlocksRegistry,{getSetting:p}=window.wc.wcSettings,{CheckboxControl:g}=window.wc.blocksCheckout,{useSelect:k}=window.wp.data,b=p("p24-card_data",{}),y=(0,e.decodeEntities)(b.title),f=b.i18n||{},w=new class extends d{constructor(e){super();const{config:t,mode:s="sandbox",lang:n="pl",clickToPay:r,recurring:i=!1,debug:a=!1}=e,{merchant_id:o,session_id:c,signature:l,options:d}=t;this.debug=a,this.tokenizerElement="card-tokenizer",this.merchantId=o,this.sessionId=c,this.signature=l,this.recurring=i,this.mode=s,this.clickToPay=r,this.whiteLabel=new h({...e}),this.tokenizer=null,this.error=null,this.cardData=null,this.oneClick=!1,this.saveOneClick=!1,this.regulation="1",this.checkout="1",this.prepareOptions(d,n)}prepareOptions(e,t){this.options="string"==typeof e?JSON.parse(e):e||{},this.options.lang=t,this.options.loader=!0,this.options.errorMessage=!1,this.options.c2p=!!this.clickToPay?.enabled}setClickToPayEmail(e){this.options.c2p&&(this.options.psu={email:e})}setSaveOneClick(e){this.saveOneClick=e}setOneClick(e){this.oneClick=e}setRegulation(){this.regulation="1"}setCheckout(e){this.checkout=e}async prepareData(){return this.error=null,this.cardData=null,!!this.oneClick||await this.tokenize()}async tokenize(){const e=this.saveOneClick||this.recurring?"permanent":"temporary";this.recurring&&(this.options.recurringConsent=!0,this.options.recurringConsentAt=(new Date).toISOString());const t=await this.tokenizer.tokenize(e),{errors:s=[],data:n}=t?.data||{};return s.length?(this.error=s[0],!1):(this.cardData=n,!0)}getError(){return this.error}loadTokenizer(){u("card-tokenizer-script",`https://${this.mode}.przelewy24.pl/js/cardTokenizationIframe.min.js?mid=${this.merchantId}`,(()=>this.onLoadTokenizer()))}onLoadTokenizer(){this.tokenizer=new Przelewy24CardTokenization(this.merchantId,this.sessionId,this.signature),this.tokenizer.render("form",`#${this.tokenizerElement}`,this.options)}getPaymentData(){const e=!!this.oneClick&&String(this.oneClick),t={};return this.cardData&&"object"==typeof this.cardData&&Object.keys(this.cardData).forEach((e=>{let s=this.cardData[e];if(null==s)s=!1;else if(Array.isArray(s)||"object"==typeof s)try{s=JSON.stringify(s)}catch(e){s=String(s)}else"number"==typeof s?s=String(s):"boolean"==typeof s||(s=String(s));t[e]=s})),{type:this.oneClick?"one-click":"card-data",regulation:"1",checkout:this.checkout,...t,save:this.saveOneClick?"1":"0",oneClick:e,oneclick:e}}}(b),v=({onChange:e,options:t,value:s})=>{const r=null==s?null:String(s);return t.length?(0,n.jsxs)("div",{className:"p24-1clicks",children:[(0,n.jsx)("div",{className:"p24-1clicks__label",children:f.use_saved}),(0,n.jsx)("div",{className:"p24-1clicks__items",children:t.map(((t,i)=>{const a=null==t.id?null:String(t.id),o=r===a;let c="p24-1click p24-1click--card";return o&&(c+=" p24-1click--active"),(0,n.jsxs)("button",{className:c,type:"button",onClick:()=>(t=>{const n=null==t?null:String(t),r=null==s?null:String(s);e(r===n?null:n)})(t.id),"aria-pressed":o,"data-oneclickid":a,children:[t?.logo&&(0,n.jsx)("figure",{className:"p24-1click__logo p24-1click--card__logo",children:(0,n.jsx)("img",{src:t.logo.url,alt:t.logo.alt})}),(0,n.jsxs)("span",{className:"p24-1click--card__number",children:[(0,n.jsx)("small",{children:"✱✱✱✱ ✱✱✱✱ ✱✱✱✱"})," ",t.last_digits]}),(0,n.jsx)("span",{className:"p24-1click--card__valid",children:t.valid_to})]},i)}))}),(0,n.jsx)("div",{className:"p24-1clicks__or",children:f.or})]}):null},x=({eventRegistration:e,emitResponse:s})=>{const[r,a]=(0,t.useState)(!1),[o,l]=(0,t.useState)(null),[d,u]=function(e=null){const[s,n]=(0,t.useState)(!1),[r,i]=(0,t.useState)(null),[a,o]=(0,t.useState)(!0),c=e=>{const t=document.querySelector(".wc-block-components-checkout-place-order-button__text");if(!t)return;const s=t.closest("button")||t.closest('input[type="submit"]')||document.querySelector(".wc-block-components-checkout-place-order-button");s&&(e?(s.setAttribute("disabled","disabled"),s.setAttribute("aria-disabled","true")):(s.removeAttribute("disabled"),s.setAttribute("aria-disabled","false")))};return(0,t.useEffect)((()=>{const e=()=>document.querySelector('.p24-payment-container input[type="checkbox"][required]'),t=e=>{o(!!e.target.checked)};return(()=>{const s=e();s&&o(!!s.checked),s&&s.addEventListener("change",t)})(),()=>{const s=e();s&&s.removeEventListener("change",t)}}),[]),(0,t.useEffect)((()=>{const e=e=>{const{data:t}=e;if(t?.p24&&"ready"===t?.type){if(!1===t.status){n(!1);const e={invalidCardHolder:"Niepoprawne dane w formularzu kartowym: Imię i nazwisko",invalidExpirationDate:"Niepoprawne dane w formularzu kartowym: Data ważności karty",invalidCardNumber:"Niepoprawne dane w formularzu kartowym: Numer karty",invalidCVV:"Niepoprawne dane w formularzu kartowym: Kod CVV"},s=Array.isArray(t.error)?t.error[0]:null,r=s&&e[s]?e[s]:"Wystąpił problem z formularzem kartowym. Popraw błędy na formularzu, wybierz inną metodę płatności lub spróbuj ponownie.";i(r),c(!0)}!0===t.status&&(n(!0),i(null),a&&c(!1))}};return window.addEventListener("message",e),()=>window.removeEventListener("message",e)}),[a]),(0,t.useEffect)((()=>{if(!a)return i("Musisz zaakceptować regulamin, aby skorzystać z wybranej metody"),void c(!0);s&&(i(null),c(!1))}),[a,s]),(0,t.useEffect)((()=>{if(e)return n(!0),i(null),void(a&&c(!1));c(!s||!a)}),[e,s,a]),[s,r]}(o),{responseTypes:h,noticeContexts:m}=s,{onPaymentSetup:p,onCheckoutSuccess:y,onCheckoutFail:x}=e,[C,E,S,j]=function(e,s){const[n,r]=(0,t.useState)(""),[i,a]=(0,t.useState)(!1),[o,c]=(0,t.useState)(!1),[l,d]=(0,t.useState)(!0);return(0,t.useEffect)((()=>{o&&r(l&&!i?s:"")}),[i,l,o]),[i,n,t=>{o||c(!0),e&&e.setRegulation(t),a(t)},(e=!0)=>{let t=!1;return e&&!i?(r(s),t=!1):(e&&i||!e)&&(r(""),t=!0),t},e=>{e||r(""),d(e)}]}(w,f.error.rules),[L,N]=(0,t.useState)(!(b.oneClick?.enabled&&b.oneClick.items?.length)),z=!0===b.hasSubscription,I=b.clickToPay?.enabled?k((e=>e("wc/store/cart").getCustomerData()?.billingAddress?.email)):null,P=({errorMessage:e})=>(0,n.jsx)("div",{className:"wc-block-components-validation-input-error",children:(0,n.jsx)("p",{role:"alert",children:e})});return(0,t.useEffect)((()=>{if(b.clickToPay?.enabled){I&&w.setClickToPayEmail(I);const e=e=>{"email"===e.target.id&&(w.setClickToPayEmail(e.target.value),w.reRenderTokenizer())};return document.addEventListener("change",e),()=>document.removeEventListener("change",e)}}),[]),(0,t.useEffect)((()=>{L&&w.loadTokenizer(),w.whiteLabel.init(),w.whiteLabel.runObserver()}),[L]),(0,t.useEffect)((()=>{w.setSaveOneClick(!z&&r)}),[r]),(0,t.useEffect)((()=>{w.setOneClick(o?Number(o):null),o&&a(!1)}),[o]),(0,t.useEffect)((()=>{const e=p((async()=>{const e={type:h.ERROR};if(!j())return e;if(!o&&L&&!d)return e.message=u||"Wystąpił problem z formularzem kartowym.",e.messageContext=m.PAYMENTS,e;await w.prepareData();const t=w.getPaymentData();if(!t)return e.message=w.getError(),e.messageContext=m.PAYMENTS,e;t.cardData&&"object"==typeof t.cardData&&Object.keys(t.cardData).forEach((e=>{let s=t.cardData[e];if(null==s)t.cardData[e]=!1;else if(Array.isArray(s)||"object"==typeof s)try{t.cardData[e]=JSON.stringify(s)}catch(n){t.cardData[e]=String(s)}else t.cardData[e]="number"==typeof s?String(s):"boolean"==typeof s?s:String(s)}));const s=!!t.oneClick&&String(t.oneClick);return t.oneClick=s,t.oneclick=s,z&&(o&&t.cardData&&(t.cardData.transactionType="initial"),t.cardData&&(t.cardData.recurringConsent=!!r,t.cardData.recurringConsentAt=(new Date).toISOString())),e.type=h.SUCCESS,e.meta={paymentMethodData:t},e}));return()=>e()}),[d,u,C,E,r,o,L,z,p,h.ERROR,h.SUCCESS]),(0,t.useEffect)((()=>{const e=y((async({processingResponse:e})=>{const t=document.getElementById("p24-3ds-modal"),s=document.getElementById("p24-3ds-loader"),n=document.getElementById("p24-3ds-iframe-wrapper");t&&t.classList.remove("hidden"),s&&s.classList.remove("hidden");const r={type:h.ERROR},i=await w.whiteLabel.onResponse(e?.paymentDetails||{}),a=n?n.querySelector("iframe"):null;a?a.addEventListener("load",(()=>{s&&s.classList.add("hidden"),t&&t.classList.add("hidden"),a&&a.remove()}),{once:!0}):s&&s.classList.add("hidden");const o=()=>{if(s&&s.classList.add("hidden"),t&&t.classList.add("hidden"),n){const e=n.querySelector("iframe");e&&e.remove()}};return i.success&&i.redirect?(r.type=h.SUCCESS,r.redirectUrl=i.redirect,o()):i.error&&i.message?(r.message=i.message,r.messageContext=m.PAYMENTS,o()):o(),r})),t=x((({processingResponse:e})=>{const t={type:h.ERROR},s=e?.paymentDetails?.message;s&&(t.message=s,t.messageContext=m.PAYMENTS);const n=document.getElementById("p24-3ds-modal"),r=document.getElementById("p24-3ds-loader"),i=document.getElementById("p24-3ds-iframe-wrapper");if(r&&r.classList.add("hidden"),n&&n.classList.add("hidden"),i){const e=i.querySelector("iframe");e&&e.remove()}return t}));return()=>{e(),t()}}),[y,x,h]),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"p24-payment-container",children:[b.description&&(0,n.jsx)(i,{description:b.description}),b.oneClick.enabled&&(0,n.jsx)(v,{value:o,onChange:l,options:b.oneClick.items}),!L&&b.oneClick.enabled&&(0,n.jsxs)("button",{type:"button",className:"p24-1clicks__new-card",onClick:()=>N(!0),children:[(0,n.jsxs)("svg",{className:"p24-1clicks__new-card-icon",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("rect",{x:"1",y:"4",width:"22",height:"16",rx:"2",ry:"2"}),(0,n.jsx)("line",{x1:"1",y1:"10",x2:"23",y2:"10"}),(0,n.jsx)("circle",{cx:"12",cy:"16",r:"2"})]}),(0,n.jsx)("span",{className:"p24-1clicks__new-card-text",children:f.use_new_card})]}),L&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{id:"card-tokenizer"}),u&&(0,n.jsx)(P,{errorMessage:u}),(0,n.jsx)("div",{id:"card-whitelabel"})]}),b.oneClick?.enabled&&b.oneClick?.items&&b.oneClick.items.length>0&&(0,n.jsx)("div",{className:"p24-checkbox",children:(0,n.jsx)(g,{disabled:!!o,label:z?f.label.save_recurring:f.label.save_oneclick,checked:Boolean(r),onChange:e=>a(Boolean(e))})}),(0,n.jsxs)("div",{className:"p24-checkbox",children:[(0,n.jsx)(c,{required:!0,label:f.label.regulation,checked:Boolean(C),onChange:e=>S(Boolean(e))}),E&&(0,n.jsx)(P,{errorMessage:E})]})]}),(0,n.jsx)("div",{id:"p24-3ds-modal",className:"p24-3ds-modal hidden fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center",children:(0,n.jsxs)("div",{className:"modal-content relative bg-white rounded shadow-lg p-4",children:[(0,n.jsx)("div",{id:"p24-3ds-loader",className:"absolute inset-0 flex items-center justify-center bg-white bg-opacity-80",children:(0,n.jsx)("div",{className:"loader border-4 border-blue-500 border-t-transparent rounded-full w-12 h-12 animate-spin"})}),(0,n.jsx)("div",{id:"p24-3ds-iframe-wrapper"})]})})]})};m({name:b.name,label:(0,n.jsx)(l,{label:y,icon:b.icon}),content:(0,n.jsx)(x,{}),edit:(0,n.jsx)(i,{description:b.description}),canMakePayment:()=>!0,ariaLabel:y,supports:{features:b.supports}})})();