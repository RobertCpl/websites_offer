!function(){"use strict";class e{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}const t=async(e,t,s=()=>{},i=!1)=>{let r=document.getElementById(e);if(r&&i&&(r.remove(),r=!1),!r){const i=document.createElement("script");return i.src=t,i.id=e,document.head.appendChild(i),await new Promise((e=>{i.addEventListener("load",(()=>e(s())))}))}return s(),!0};class s{constructor(e){const{mode:t="sandbox",debug:s=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=s,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}getLoader(){return document.getElementById("p24-3ds-loader")}openModal(){const e=this.getModal(),t=this.getLoader();e&&(e.classList.remove("hidden"),e.classList.add("active")),t&&t.classList.remove("hidden")}closeModal(){const e=this.getModal(),t=this.getLoader();e&&(e.classList.add("hidden"),e.classList.remove("active")),t&&t.classList.add("hidden")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();if(!e)return;new MutationObserver((t=>{t.forEach((()=>{const t=e.querySelector("iframe");t&&t.addEventListener("load",(()=>{const e=this.getLoader();e&&e.classList.add("hidden")}),{once:!0})}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await t("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0);const s=this.getLoader(),i=this.getModal();if(s&&i){const e=setTimeout((()=>{s&&s.classList.add("hidden")}),12e3),t=this.getIframeWrapper(),i=t?t.querySelector("iframe"):null;i&&i.addEventListener("load",(()=>clearTimeout(e)),{once:!0})}}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,s)=>{const{error:i,token:r,redirect:o}=e;this.promise.resolve=t,this.promise.reject=s,this.promise.redirect=o,i?t({error:i}):r&&(this.debug&&console.log("[P24] Transaction token:",r),this.load(r),o&&console.log("[P24] Redirect fallback:",o))}))}}class i extends e{constructor(e){super();const{config:t,mode:i="sandbox",lang:r="pl",clickToPay:o,recurring:n=!1,debug:a=!1}=e,{merchant_id:c,session_id:l,signature:h,options:d}=t;this.debug=a,this.tokenizerElement="card-tokenizer",this.merchantId=c,this.sessionId=l,this.signature=h,this.recurring=n,this.mode=i,this.clickToPay=o,this.whiteLabel=new s({...e}),this.tokenizer=null,this.error=null,this.cardData=null,this.oneClick=!1,this.saveOneClick=!1,this.regulation="1",this.checkout="1",this.prepareOptions(d,r)}prepareOptions(e,t){this.options="string"==typeof e?JSON.parse(e):e||{},this.options.lang=t,this.options.loader=!0,this.options.errorMessage=!1,this.options.c2p=!!this.clickToPay?.enabled}setClickToPayEmail(e){this.options.c2p&&(this.options.psu={email:e})}setSaveOneClick(e){this.saveOneClick=e}setOneClick(e){this.oneClick=e}setRegulation(){this.regulation="1"}setCheckout(e){this.checkout=e}async prepareData(){return this.error=null,this.cardData=null,!!this.oneClick||await this.tokenize()}async tokenize(){const e=this.saveOneClick||this.recurring?"permanent":"temporary";this.recurring&&(this.options.recurringConsent=!0,this.options.recurringConsentAt=(new Date).toISOString());const t=await this.tokenizer.tokenize(e),{errors:s=[],data:i}=t?.data||{};return s.length?(this.error=s[0],!1):(this.cardData=i,!0)}getError(){return this.error}loadTokenizer(){t("card-tokenizer-script",`https://${this.mode}.przelewy24.pl/js/cardTokenizationIframe.min.js?mid=${this.merchantId}`,(()=>this.onLoadTokenizer()))}onLoadTokenizer(){this.tokenizer=new Przelewy24CardTokenization(this.merchantId,this.sessionId,this.signature),this.tokenizer.render("form",`#${this.tokenizerElement}`,this.options)}getPaymentData(){const e=!!this.oneClick&&String(this.oneClick),t={};return this.cardData&&"object"==typeof this.cardData&&Object.keys(this.cardData).forEach((e=>{let s=this.cardData[e];if(null==s)s=!1;else if(Array.isArray(s)||"object"==typeof s)try{s=JSON.stringify(s)}catch(e){s=String(s)}else"number"==typeof s?s=String(s):"boolean"==typeof s||(s=String(s));t[e]=s})),{type:this.oneClick?"one-click":"card-data",regulation:"1",checkout:this.checkout,...t,save:this.saveOneClick?"1":"0",oneClick:e,oneclick:e}}}class r{constructor(e){this.parent=e,this.notice=document.createElement("div"),this.notice.classList.add("wc-block-components-notice-banner"),this.notice.classList.add("is-error")}show(e){e&&(e="object"==typeof e?e?.message:e,this.notice.innerHTML=e,this.parent.prepend(this.notice))}hide(){this.notice.remove()}}class o{constructor(){this.selectors={form:document.querySelector("form.p24-payment-container"),submitButton:document.getElementById("submit"),regulation:document.getElementById("regulation")},this.config=window._config,this.service=null,this.notice=new r(this.selectors.form),this.submitHandler(),this.regulationHandlers()}regulationHandlers(){const{regulation:e}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setRegulation(e.checked)}))}submitHandler(){const{form:e}=this.selectors;e.addEventListener("submit",(e=>{e.preventDefault(),this.notice.hide(),this.submit()}))}async submit(){}async submitData(){const e={type:"register-transaction",orderId:this.config.orderId,orderKey:this.config.orderKey,checkout:this.service.checkout,paymentDetails:this.service.getPaymentData()};let t=await fetch(this.config.url,{method:"POST",body:JSON.stringify(e)});const{data:s}=await t.json()||{data:{}};return s}}class n extends o{constructor(){super(),this.selectors={...this.selectors,saveOneClick:document.getElementById("save-one-click"),oneClickItems:document.querySelectorAll(".woocommerce-order-pay .p24-1click")},this.oneClickHandlers()}oneClickHandlers(){const{saveOneClick:e,oneClickItems:t}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setSaveOneClick(e.checked)})),t.length&&t.forEach((s=>s.addEventListener("click",(()=>{const{id:i}=s.dataset,{oneClick:r}=this.service;t.forEach((e=>e.classList.remove("p24-1click--active"))),console.log(r,i),r===i?(this.service.setOneClick(!1),this.service.setSaveOneClick(!1),e.checked=!1):(s.classList.add("p24-1click--active"),this.service.setOneClick(i))}))))}}class a extends n{constructor(){super(),this.service=new i(_config),this.service.setCheckout("legacy"),this.service.loadTokenizer(),this.service.whiteLabel.init(),this.service.whiteLabel.runObserver()}async submit(){const{submitButton:e}=this.selectors;e.disabled=!0;try{if(await this.service.prepareData(),this.service.hasError())throw new Error(this.service.getError());const e=await this.submitData();if(e.error)throw new Error(e.error);await this.service.whiteLabel.onResponse(e)}catch(e){this.notice.show(e)}e.disabled=!1}}window.addEventListener("DOMContentLoaded",(()=>{window.p24CardReceipt=new a}))}();
